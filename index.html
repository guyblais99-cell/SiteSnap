<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Site Snap</title>

    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#2563EB">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Site Snap">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        html, body { overscroll-behavior-y: contain; }
        .view-container { transition: opacity 0.2s ease-in-out; width: 100%; }
        .hidden-view { display: none !important; opacity: 0; }
        .active-view { display: block !important; opacity: 1; }
        #login-view.active-view { display: flex !important; }
        .loader {
            border-top-color: #3B82F6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- SORTABLE STYLES --- */
        .sortable-drag { opacity: 0 !important; }
        .sortable-fallback-styling {
            opacity: 1 !important;
            background-color: rgba(255, 255, 255, 0.9) !important;
            border: 2px dashed #3B82F6 !important;
            border-radius: 1rem !important; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000 !important;
            display: block !important; 
            visibility: visible !important;
        }
        .build-ghost {
            background: #DBEAFE !important; 
            border: 2px dashed #3B82F6 !important; 
            border-radius: 1rem !important; 
            color: transparent !important; 
            opacity: 1 !important;
        }
        .build-ghost > * { opacity: 0 !important; visibility: hidden !important; }
        .task-ghost {
            background: #DBEAFE !important; 
            border: 2px dashed #3B82F6 !important; 
            border-radius: 1.125rem !important; 
            color: transparent !important;
            opacity: 1 !important;
        }
        .task-ghost > * { opacity: 0 !important; visibility: hidden !important; }
        
        /* --- SELECTION MODE STYLES --- */
        .selection-checkbox-wrapper {
            width: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
            margin-left: 0;
        }
        .selection-mode-active .selection-checkbox-wrapper {
            width: 2rem;
            opacity: 1;
            margin-left: 0.5rem;
        }

        .custom-checkbox {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 0.375rem;
            border: 2px solid #D1D5DB;
            appearance: none;
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #2563EB;
            border-color: #2563EB;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-[100dvh] flex flex-col">

    <nav id="main-nav" class="bg-white border-b border-gray-200 px-4 py-3 flex items-center sticky top-0 z-40 shadow-sm flex-shrink-0 hidden">
        <div class="w-full max-w-5xl mx-auto flex items-center justify-between">
            <div class="flex items-center flex-1 overflow-hidden mr-2">
                 <div id="nav-breadcrumbs" class="flex items-center text-lg font-bold truncate">
                 </div>
            </div>
            <div class="flex items-center flex-shrink-0">
                <span id="workspace-badge" class="hidden md:inline-block bg-blue-100 text-blue-800 text-xs font-semibold mr-3 px-2.5 py-0.5 rounded"></span>
                <button onclick="signOutWorkspace()" class="text-gray-500 hover:text-red-600 p-2 mr-2 transition-colors" title="Sign Out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
                <div id="connection-status" class="w-3 h-3 rounded-full bg-red-500"></div>
            </div>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto w-full" id="main-content">
        
        <div id="initial-loader" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50 px-8 text-center">
            <div id="loader-spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <div id="loader-error" class="hidden">
                <div class="bg-red-100 text-red-800 p-4 rounded-2xl mb-4">
                    <h3 class="font-bold text-lg">Connection Failed</h3>
                    <p id="loader-error-msg" class="text-sm mt-2">Could not connect to database.</p>
                </div>
                <button onclick="window.location.reload()" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold">Try Again</button>
            </div>
        </div>

        <div id="global-busy" class="fixed inset-0 z-[60] bg-black bg-opacity-70 hidden flex flex-col items-center justify-center text-white">
             <div class="loader ease-linear rounded-full border-4 border-t-4 border-blue-500 h-12 w-12 mb-4"></div>
             <p id="global-busy-msg" class="font-bold text-lg">Processing...</p>
        </div>

        <div id="login-view" class="view-container active-view h-full items-center justify-center p-6">
            <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full mx-auto border border-gray-100 -mt-20">
                <div class="text-center mb-8">
                    <div class="bg-blue-600 text-white p-4 rounded-2xl inline-flex mb-4 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Site Snap</h1>
                    <p class="text-gray-500 mt-2 font-medium">Collaborative Site Docs</p>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-900 mb-2 ml-1">Workspace ID</label>
                        <input type="text" id="workspace-id-input" placeholder="e.g., Jobsite-Alpha" class="w-full px-4 py-4 rounded-xl border-2 border-gray-200 focus:ring-0 focus:border-blue-600 outline-none transition-all font-medium text-lg" onkeyup="if(event.key === 'Enter') joinWorkspace()">
                    </div>
                    <button onclick="joinWorkspace()" id="join-btn" disabled class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white font-bold py-4 rounded-xl transition-all active:scale-95 shadow-md text-lg">
                        Join Workspace
                    </button>
                </div>
            </div>
        </div>

        <div id="builds-view" class="view-container hidden-view p-4 w-full max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-extrabold text-gray-900">Build Folders</h1>
                <div class="flex space-x-2">
                    <button id="select-btn-builds" onclick="toggleSelectionMode()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-3 rounded-xl font-bold transition-all active:scale-95">
                        Select
                    </button>
                    <button onclick="openModal('new-build-modal')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl font-bold flex items-center transition-all shadow-sm active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        New
                    </button>
                </div>
            </div>
            <div id="builds-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-24">
                </div>
             <div id="no-builds-msg" class="hidden flex flex-col items-center justify-center py-16 text-gray-500">
                <div class="bg-white p-6 rounded-full shadow-sm mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                    </svg>
                </div>
                <p class="text-xl font-bold text-gray-700">No builds yet</p>
            </div>
        </div>

        <div id="tasks-view" class="view-container hidden-view p-4 w-full max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="overflow-hidden flex-1">
                     <h1 id="current-build-title" class="text-2xl sm:text-3xl font-extrabold text-gray-900 truncate pr-4 leading-tight">Build Name</h1>
                     <p class="text-gray-500 font-bold">Task List</p>
                </div>
                <div class="flex space-x-2 flex-shrink-0">
                    <button id="select-btn-tasks" onclick="toggleSelectionMode()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-3 rounded-xl font-bold transition-all active:scale-95">
                        Select
                    </button>
                    <button onclick="openModal('new-task-modal')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-xl font-bold flex items-center transition-all shadow-sm active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        New
                    </button>
                </div>
            </div>
            <div id="tasks-list" class="space-y-3 pb-24">
                </div>
            <div id="no-tasks-msg" class="hidden flex flex-col items-center justify-center py-16 bg-white rounded-3xl border-2 border-dashed border-gray-200">
                <p class="font-bold text-lg text-gray-700">No tasks created yet</p>
            </div>
        </div>

        <div id="images-view" class="view-container hidden-view p-4 w-full max-w-5xl mx-auto">
            <div class="mb-6">
                <h1 id="current-task-title" class="text-2xl sm:text-3xl font-extrabold text-gray-900 mb-1 leading-tight">Task Name</h1>
                <p class="text-gray-500 font-bold">Photo Documentation</p>
            </div>

            <div class="mb-6 bg-white p-5 rounded-3xl shadow-sm border border-blue-100 flex items-center justify-between sticky top-2 z-10">
                 <div>
                    <h3 class="text-xl font-extrabold text-gray-900">Add Photo</h3>
                    <p class="text-sm font-medium text-gray-500 mt-1">Auto-compressed</p>
                 </div>
                 <label for="camera-input" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-2xl shadow-lg cursor-pointer active:scale-95 transition-all flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <input id="camera-input" type="file" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event)">
                </label>
            </div>

            <div id="upload-progress" class="hidden mb-6 bg-blue-50 p-4 rounded-2xl border border-blue-200 flex items-center animate-pulse">
                <div class="loader ease-linear rounded-full border-2 border-t-2 border-blue-600 h-5 w-5 mr-3"></div>
                <span class="text-blue-800 font-bold">Compressing & Uploading...</span>
            </div>

            <div id="images-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 pb-20">
                </div>
            <div id="no-images-msg" class="hidden flex flex-col items-center justify-center py-20 bg-white rounded-3xl border-2 border-dashed border-gray-200 mt-4">
                <p class="font-bold text-xl text-gray-700">No photos yet</p>
                <p class="text-gray-500 mt-2">Tap the camera icon to start.</p>
            </div>
        </div>

    </main>

    <div id="bulk-action-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-2xl transform translate-y-full transition-transform duration-300 z-40 flex items-center justify-between p-4 px-6">
        <div class="font-bold text-gray-700"><span id="selected-count">0</span> Selected</div>
        <div class="flex space-x-4">
            <button onclick="handleBulkDelete()" class="flex items-center bg-red-100 text-red-700 px-4 py-3 rounded-xl font-bold hover:bg-red-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete
            </button>
            <button onclick="handleBulkDownload()" class="flex items-center bg-blue-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-blue-700 transition-colors shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download
            </button>
        </div>
    </div>

    <div id="new-build-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-all">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-6 sm:p-8 animate-slide-up sm:animate-none shadow-2xl">
            <h2 class="text-2xl font-extrabold mb-6 text-gray-900">New Build Folder</h2>
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-900 mb-2 ml-1">Folder Name</label>
                <input type="text" id="new-build-name" placeholder="e.g., Project Alpha" class="w-full border-2 border-gray-200 rounded-xl px-4 py-4 focus:outline-none focus:border-blue-600 transition-colors font-semibold text-lg" onkeyup="if(event.key === 'Enter') confirmCreateBuild()">
            </div>
            <div class="flex space-x-3">
                <button onclick="closeModal('new-build-modal')" class="flex-1 py-4 text-gray-700 font-bold bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">Cancel</button>
                <button onclick="confirmCreateBuild()" class="flex-1 py-4 text-white font-bold bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors shadow-md">Create</button>
            </div>
        </div>
    </div>

    <div id="new-task-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-all">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-md p-6 sm:p-8 shadow-2xl">
            <h2 class="text-2xl font-extrabold mb-6 text-gray-900">New Task</h2>
             <div class="mb-6">
                <label class="block text-sm font-bold text-gray-900 mb-2 ml-1">Task Name</label>
                <input type="text" id="new-task-name" placeholder="e.g., Foundation Inspection" class="w-full border-2 border-gray-200 rounded-xl px-4 py-4 focus:outline-none focus:border-blue-600 transition-colors font-semibold text-lg" onkeyup="if(event.key === 'Enter') confirmCreateTask()">
            </div>
            <div class="flex space-x-3">
                <button onclick="closeModal('new-task-modal')" class="flex-1 py-4 text-gray-700 font-bold bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">Cancel</button>
                <button onclick="confirmCreateTask()" class="flex-1 py-4 text-white font-bold bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors shadow-md">Create</button>
            </div>
        </div>
    </div>

    <div id="image-preview-modal" class="fixed inset-0 bg-black z-50 hidden flex flex-col transition-opacity">
         <div class="flex justify-between p-6 pt-12 z-50 relative">
             <div class="flex items-center space-x-4">
                  <button onclick="deleteCurrentImage()" class="text-white p-2 bg-red-600 bg-opacity-80 rounded-full hover:bg-opacity-100 transition-all backdrop-blur-md flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                 </button>
                  <button onclick="downloadCurrentImage()" class="text-white p-2 bg-blue-600 bg-opacity-80 rounded-full hover:bg-opacity-100 transition-all backdrop-blur-md flex items-center justify-center">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                 </button>
             </div>
             <button onclick="closeModal('image-preview-modal')" class="text-white p-2 bg-gray-800 bg-opacity-50 rounded-full hover:bg-opacity-70 transition-all backdrop-blur-md">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
             </button>
         </div>
         <div class="flex-1 flex items-center justify-center p-4 overflow-hidden absolute inset-0" onclick="closeModal('image-preview-modal')">
             <img id="preview-image-el" src="" class="max-w-full max-h-full object-contain drop-shadow-2xl" alt="Preview">
         </div>
         <div class="p-6 pb-12 text-white bg-gradient-to-t from-black/90 to-transparent relative z-40 pointer-events-none">
             <p id="preview-name" class="text-xl font-bold text-center mb-1"></p>
             <p id="preview-meta" class="font-medium opacity-75 text-sm text-center"></p>
         </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, deleteDoc, doc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAcQbRXDz2lQDWtjXJDKxctYUeMwJVOB1s",
            authDomain: "site-snap-2a599.firebaseapp.com",
            databaseURL: "https://site-snap-2a599-default-rtdb.firebaseio.com",
            projectId: "site-snap-2a599",
            storageBucket: "site-snap-2a599.firebasestorage.app",
            messagingSenderId: "68545202261",
            appId: "1:68545202261:web:9d43627021069515e7ecdc",
            measurementId: "G-EM9SRFPNGE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "my-site-snap-production";
        const BASE_PATH = `artifacts/${APP_ID}/public/data`;

        let state = {
            currentView: 'login',
            workspaceId: null,
            currentBuild: null,
            currentTask: null,
            user: null,
            currentImageId: null,
            currentImageData: null,
            imageCountInTask: 0,
            unsubBuilds: null,
            unsubTasks: null,
            unsubImages: null,
            sortableBuilds: null,
            sortableTasks: null,
            selectedItems: new Set(),
            isSelectionMode: false // Track mode
        };

        const loaderTimeout = setTimeout(() => {
            if (!document.getElementById('initial-loader').classList.contains('hidden')) {
                showConnectionError("Connection timed out. Please check internet.");
            }
        }, 15000);

        function showConnectionError(msg) {
             document.getElementById('loader-spinner').classList.add('hidden');
             document.getElementById('loader-error').classList.remove('hidden');
             document.getElementById('loader-error-msg').textContent = msg;
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                clearTimeout(loaderTimeout);
                state.user = user;
                document.getElementById('connection-status').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('initial-loader').classList.add('hidden');
                document.getElementById('join-btn').disabled = false;
                const savedWs = localStorage.getItem('lastWorkspaceId');
                if (savedWs) {
                    document.getElementById('workspace-id-input').value = savedWs;
                    joinWorkspace();
                }
            } else {
                signInAnonymously(auth).catch(e => {
                    clearTimeout(loaderTimeout);
                    let msg = "Connection failed.";
                    if (e.code === 'auth/configuration-not-found') msg = "Enable 'Anonymous' sign-in in Firebase Console.";
                    showConnectionError(msg);
                });
            }
        });

        window.joinWorkspace = () => {
            const wsId = document.getElementById('workspace-id-input').value.trim().toUpperCase();
            if (!wsId) return;
            state.workspaceId = wsId;
            localStorage.setItem('lastWorkspaceId', wsId);
            document.getElementById('workspace-badge').textContent = `WS: ${wsId}`;
            document.getElementById('login-view').classList.remove('active-view');
            document.getElementById('login-view').classList.add('hidden-view');
            document.getElementById('main-nav').classList.remove('hidden');
            
            const lastView = localStorage.getItem('lastView');
            const lastBuild = localStorage.getItem('lastBuild');
            const lastTask = localStorage.getItem('lastTask');

            if (lastView === 'images' && lastBuild && lastTask) {
                try {
                    const build = JSON.parse(lastBuild);
                    const task = JSON.parse(lastTask);
                    state.currentBuild = build;
                    navigateTo('images', task);
                } catch (e) {
                    console.error("Failed to restore session", e);
                    navigateTo('builds');
                }
            } else if (lastView === 'tasks' && lastBuild) {
                try {
                    const build = JSON.parse(lastBuild);
                    navigateTo('tasks', build);
                } catch (e) {
                    console.error("Failed to restore session", e);
                    navigateTo('builds');
                }
            } else {
                navigateTo('builds');
            }
        }

        window.signOutWorkspace = () => {
            if (confirm("Sign out of current workspace?")) {
                state.workspaceId = null;
                localStorage.removeItem('lastWorkspaceId');
                localStorage.removeItem('lastView');
                localStorage.removeItem('lastBuild');
                localStorage.removeItem('lastTask');

                if (state.unsubBuilds) state.unsubBuilds();
                if (state.unsubTasks) state.unsubTasks();
                if (state.unsubImages) state.unsubImages();
                
                document.getElementById('main-nav').classList.add('hidden');
                ['builds-view', 'tasks-view', 'images-view'].forEach(id => {
                     document.getElementById(id).classList.remove('active-view');
                     document.getElementById(id).classList.add('hidden-view');
                });
                document.getElementById('login-view').classList.remove('hidden-view');
                document.getElementById('login-view').classList.add('active-view');
                document.getElementById('workspace-id-input').value = '';
            }
        }

        window.navigateTo = (view, data = null) => {
            // Reset selection mode on navigation
            if (state.isSelectionMode) toggleSelectionMode();
            
            if (state.currentView === 'builds' && view !== 'builds') { 
                if (state.sortableBuilds) state.sortableBuilds.destroy(); 
                state.sortableBuilds = null; 
            }
            if (state.currentView === 'tasks' && view !== 'tasks') { 
                if (state.unsubTasks) state.unsubTasks(); 
                state.unsubTasks = null; 
                if (state.sortableTasks) state.sortableTasks.destroy(); 
                state.sortableTasks = null; 
            }
            if (state.currentView === 'images' && view !== 'images') { if (state.unsubImages) state.unsubImages(); state.unsubImages = null; }
            state.currentView = view;
            document.getElementById('main-content').scrollTop = 0; 

            if (view === 'builds') {
                state.currentBuild = null;
                state.currentTask = null;
                showView('builds-view'); loadBuilds();
            } else if (view === 'tasks') {
                if (data) state.currentBuild = data;
                state.currentTask = null;
                document.getElementById('current-build-title').textContent = state.currentBuild.name;
                showView('tasks-view'); loadTasks(state.currentBuild.id);
            } else if (view === 'images') {
                state.currentTask = data;
                document.getElementById('current-task-title').textContent = data.name;
                showView('images-view'); loadImages(data.id);
            }
            updateBreadcrumbs();

            if (view === 'builds') {
                localStorage.setItem('lastView', 'builds');
                localStorage.removeItem('lastBuild');
                localStorage.removeItem('lastTask');
            } else if (view === 'tasks') {
                localStorage.setItem('lastView', 'tasks');
                localStorage.setItem('lastBuild', JSON.stringify(state.currentBuild));
                localStorage.removeItem('lastTask');
            } else if (view === 'images') {
                localStorage.setItem('lastView', 'images');
                localStorage.setItem('lastBuild', JSON.stringify(state.currentBuild));
                localStorage.setItem('lastTask', JSON.stringify(state.currentTask));
            }
        }

        function showView(viewId) {
            ['login-view', 'builds-view', 'tasks-view', 'images-view'].forEach(id => {
                document.getElementById(id).classList.remove('active-view');
                document.getElementById(id).classList.add('hidden-view');
            });
            document.getElementById(viewId).classList.remove('hidden-view');
            document.getElementById(viewId).classList.add('active-view');
        }

        function updateBreadcrumbs() {
            const container = document.getElementById('nav-breadcrumbs');
            let html = `<button onclick="navigateTo('builds')" class="text-blue-600 hover:bg-blue-50 p-2 -ml-2 rounded-xl transition-colors flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg></button>`;
            if (state.currentBuild && (state.currentView === 'tasks' || state.currentView === 'images')) {
                html += `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300 mx-1 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><button onclick="window.navToCurrentBuild()" class="text-blue-600 hover:underline truncate font-semibold">${state.currentBuild.name}</button>`;
            }
            if (state.currentTask && state.currentView === 'images') {
                html += `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300 mx-1 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><span class="text-gray-800 truncate font-semibold">${state.currentTask.name}</span>`;
            }
            container.innerHTML = html;
        }
        
        window.navToCurrentBuild = () => navigateTo('tasks', state.currentBuild);

        // --- SELECTION MODE LOGIC ---
        window.toggleSelectionMode = () => {
            state.isSelectionMode = !state.isSelectionMode;
            state.selectedItems.clear();
            
            // Update buttons text
            const btnIds = ['select-btn-builds', 'select-btn-tasks'];
            btnIds.forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.textContent = state.isSelectionMode ? 'Cancel' : 'Select';
                    if(state.isSelectionMode) btn.classList.replace('text-gray-800', 'text-blue-600');
                    else btn.classList.replace('text-blue-600', 'text-gray-800');
                }
            });

            // Update Container Classes
            const listIds = ['builds-list', 'tasks-list'];
            listIds.forEach(id => {
                const list = document.getElementById(id);
                if(list) {
                    if(state.isSelectionMode) list.classList.add('selection-mode-active');
                    else list.classList.remove('selection-mode-active');
                }
            });
            
            // Uncheck visible checkboxes visually
            document.querySelectorAll('.custom-checkbox').forEach(cb => cb.checked = false);
            
            updateBulkActionBar();
        };

        window.handleItemClick = (id, type) => {
            if (state.isSelectionMode) {
                // Toggle Selection
                const checkbox = document.querySelector(`div[data-id="${id}"] .custom-checkbox`);
                if (state.selectedItems.has(id)) {
                    state.selectedItems.delete(id);
                    if(checkbox) checkbox.checked = false;
                } else {
                    state.selectedItems.add(id);
                    if(checkbox) checkbox.checked = true;
                }
                updateBulkActionBar();
            } else {
                // Normal Navigation
                if (type === 'build') {
                    window.selectBuild(id);
                } else {
                    window.selectTask(id);
                }
            }
        };

        function updateBulkActionBar() {
            const bar = document.getElementById('bulk-action-bar');
            const countEl = document.getElementById('selected-count');
            const count = state.selectedItems.size;
            
            countEl.textContent = count;
            if (count > 0) {
                bar.classList.remove('translate-y-full');
            } else {
                bar.classList.add('translate-y-full');
            }
        }

        window.handleBulkDelete = async () => {
            const count = state.selectedItems.size;
            if (count === 0) return;
            
            const type = state.currentView === 'builds' ? 'folder(s)' : 'task(s)';
            
            // --- CONFIRMATION DIALOG ---
            if (!confirm(`Are you sure you want to delete ${count} ${type}?\n\nThis cannot be undone and will delete all contained data.`)) return;

            const busyEl = document.getElementById('global-busy');
            document.getElementById('global-busy-msg').textContent = "Deleting...";
            busyEl.classList.remove('hidden');

            try {
                const batchSize = 500; 
                let batch = writeBatch(db);
                let opCount = 0;

                for (const id of state.selectedItems) {
                    if (state.currentView === 'builds') {
                        const buildId = id;
                        batch.delete(doc(db, `${BASE_PATH}/builds`, buildId));
                        opCount++;
                        
                        const tasksQ = query(collection(db, `${BASE_PATH}/tasks`), where('buildId', '==', buildId));
                        const tasksSnap = await getDocs(tasksQ);
                        
                        for (const taskDoc of tasksSnap.docs) {
                            batch.delete(taskDoc.ref); 
                            opCount++;
                            const imgsQ = query(collection(db, `${BASE_PATH}/images`), where('taskId', '==', taskDoc.id));
                            const imgsSnap = await getDocs(imgsQ);
                            for (const imgDoc of imgsSnap.docs) {
                                batch.delete(imgDoc.ref);
                                opCount++;
                                if(opCount >= batchSize) { await batch.commit(); batch = writeBatch(db); opCount = 0; }
                            }
                        }
                    } else if (state.currentView === 'tasks') {
                         const taskId = id;
                         batch.delete(doc(db, `${BASE_PATH}/tasks`, taskId));
                         opCount++;
                         const imgsQ = query(collection(db, `${BASE_PATH}/images`), where('taskId', '==', taskId));
                         const imgsSnap = await getDocs(imgsQ);
                         for (const imgDoc of imgsSnap.docs) {
                            batch.delete(imgDoc.ref);
                            opCount++;
                            if(opCount >= batchSize) { await batch.commit(); batch = writeBatch(db); opCount = 0; }
                         }
                    }
                    if(opCount >= batchSize) { await batch.commit(); batch = writeBatch(db); opCount = 0; }
                }
                if (opCount > 0) await batch.commit();

                toggleSelectionMode(); 

            } catch(e) {
                console.error(e);
                alert("Some deletions failed. See console.");
            } finally {
                busyEl.classList.add('hidden');
            }
        };

        window.handleBulkDownload = async () => {
            const count = state.selectedItems.size;
            if (count === 0) return;

            const busyEl = document.getElementById('global-busy');
            const msgEl = document.getElementById('global-busy-msg');
            busyEl.classList.remove('hidden');
            msgEl.textContent = "Preparing download...";

            try {
                const zip = new JSZip();
                let zipFilename = "Archive.zip";

                // 1. DETERMINE FILENAME based on view and selection count
                if (state.currentView === 'builds') {
                    if (state.selectedItems.size === 1) {
                        const id = state.selectedItems.values().next().value;
                        if(state.tempBuilds[id]) {
                            zipFilename = `${state.tempBuilds[id].name}.zip`;
                        } else {
                            zipFilename = "Build_Export.zip";
                        }
                    } else {
                        zipFilename = `${state.workspaceId}_Export.zip`;
                    }
                } else if (state.currentView === 'tasks' && state.currentBuild) {
                     // Keep task export logic simple or as is
                     zipFilename = `${state.currentBuild.name}_Selected_Tasks.zip`;
                }

                // 2. PROCESS ITEMS
                for (const id of state.selectedItems) {
                    if (state.currentView === 'builds') {
                        const item = state.tempBuilds[id];
                        // Create main folder for the Build
                        const buildFolder = zip.folder(item.name.replace(/[^a-z0-9\s-]/gi, ''));
                        
                        const tasksQ = query(collection(db, `${BASE_PATH}/tasks`), where('buildId', '==', id), where('workspaceId', '==', state.workspaceId));
                        const tasksSnap = await getDocs(tasksQ);
                        
                        for (const taskDoc of tasksSnap.docs) {
                            const taskData = taskDoc.data();
                            // Sanitize Task Name for filename prefix
                            const safeTaskName = taskData.name.replace(/[^a-z0-9\s-]/gi, '_');
                            
                            const imgsQ = query(collection(db, `${BASE_PATH}/images`), where('taskId', '==', taskDoc.id));
                            const imgsSnap = await getDocs(imgsQ);
                            
                            imgsSnap.forEach((imgDoc, idx) => {
                                const data = imgDoc.data();
                                let originalName = data.displayName || `image_${idx + 1}.jpg`;
                                if (!originalName.toLowerCase().match(/\.(jpg|jpeg|png)$/)) originalName += '.jpg';
                                
                                // FLATTEN: Add Task Name prefix to file, put directly in Build Folder
                                const finalFileName = `${safeTaskName}_${originalName}`;
                                const base64Data = data.base64.split(',')[1];
                                
                                buildFolder.file(finalFileName, base64Data, {base64: true});
                            });
                        }

                    } else {
                        // TASKS VIEW EXPORT (Preserves sub-folders as requested)
                        const item = state.tempTasks[id];
                        const taskFolder = zip.folder(item.name.replace(/[^a-z0-9\s-]/gi, ''));
                        
                        const imgsQ = query(collection(db, `${BASE_PATH}/images`), where('taskId', '==', id), where('workspaceId', '==', state.workspaceId));
                        const imgsSnap = await getDocs(imgsQ);
                        
                        imgsSnap.forEach((imgDoc, idx) => {
                            const data = imgDoc.data();
                            let filename = data.displayName || `image_${idx + 1}.jpg`;
                            if (!filename.toLowerCase().match(/\.(jpg|jpeg|png)$/)) filename += '.jpg';
                            const base64Data = data.base64.split(',')[1];
                            taskFolder.file(filename, base64Data, {base64: true});
                        });
                    }
                }

                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, zipFilename);
                
                toggleSelectionMode(); 

            } catch (e) {
                console.error(e);
                alert("Download failed.");
            } finally {
                busyEl.classList.add('hidden');
            }
        };

        // --- CREATION LOGIC ---
        window.confirmCreateBuild = async () => {
            const input = document.getElementById('new-build-name'); 
            const name = input.value.trim(); 
            if (!name) return;
            
            try {
                closeModal('new-build-modal'); 
                input.value = '';
                
                // MODIFIED: order is negative timestamp to force top of list
                await addDoc(collection(db, `${BASE_PATH}/builds`), { 
                    workspaceId: state.workspaceId, 
                    name, 
                    createdAt: serverTimestamp(), 
                    order: -Date.now(), // Negative value forces new item to top in ascending sort
                    createdBy: state.user.uid 
                });
            } catch (e) {
                console.error(e);
                alert("Failed to create build. Check connection.");
            }
        }

        window.confirmCreateTask = async () => {
            const input = document.getElementById('new-task-name'); 
            const name = input.value.trim(); 
            if (!name) return;
            
            try {
                closeModal('new-task-modal'); 
                input.value = '';
                await addDoc(collection(db, `${BASE_PATH}/tasks`), { 
                    workspaceId: state.workspaceId, 
                    buildId: state.currentBuild.id, 
                    name, 
                    createdAt: serverTimestamp(), 
                    order: serverTimestamp(), 
                    createdBy: state.user.uid 
                });
            } catch (e) {
                console.error(e);
                alert("Failed to create task. Check connection.");
            }
        }

        // --- SORTING HELPERS ---
        function updateBuildsOrder() {
            const listEl = document.getElementById('builds-list');
            const items = listEl.querySelectorAll('.bg-white[data-id]');
            const batch = writeBatch(db);
            items.forEach((item, index) => {
                const docId = item.getAttribute('data-id');
                const docRef = doc(db, `${BASE_PATH}/builds`, docId);
                batch.update(docRef, { order: index });
            });
            batch.commit().catch(e => console.error("Failed to update build order", e));
        }

        function updateTasksOrder() {
            const listEl = document.getElementById('tasks-list');
            const items = listEl.querySelectorAll('.bg-white[data-id]');
            const batch = writeBatch(db);
            items.forEach((item, index) => {
                const docId = item.getAttribute('data-id');
                const docRef = doc(db, `${BASE_PATH}/tasks`, docId);
                batch.update(docRef, { order: index });
            });
            batch.commit().catch(e => console.error("Failed to update task order", e));
        }

        function loadBuilds() {
            if (!state.user || !state.workspaceId) return;
            if (state.unsubBuilds) state.unsubBuilds();
            if (state.sortableBuilds) state.sortableBuilds.destroy(); 

            const q = query(collection(db, `${BASE_PATH}/builds`), where('workspaceId', '==', state.workspaceId));
            state.unsubBuilds = onSnapshot(q, (snapshot) => {
                
                if (state.sortableBuilds) {
                    state.sortableBuilds.destroy();
                    state.sortableBuilds = null; 
                }

                const listEl = document.getElementById('builds-list'); listEl.innerHTML = '';
                state.tempBuilds = {}; 

                if (snapshot.empty) { document.getElementById('no-builds-msg').classList.remove('hidden'); } 
                else {
                    document.getElementById('no-builds-msg').classList.add('hidden');
                    let builds = []; snapshot.forEach(doc => builds.push({id: doc.id, ...doc.data()}));
                    
                    builds.sort((a,b) => (a.order ?? (a.createdAt?.seconds || 0)) - (b.order ?? (b.createdAt?.seconds || 0)));
                    
                    builds.forEach(build => {
                        const date = build.createdAt ? new Date(build.createdAt.seconds * 1000).toLocaleDateString() : '';
                        const el = document.createElement('div');
                        el.className = 'bg-white p-5 rounded-2xl shadow-sm border border-gray-200 hover:border-blue-400 transition-all group relative cursor-pointer';
                        el.setAttribute('data-id', build.id);
                        el.onclick = () => window.handleItemClick(build.id, 'build');
                        
                        el.innerHTML = `
                            <div class="flex items-center w-full">
                                <div class="drag-handle text-gray-400 p-2 cursor-grab active:cursor-grabbing touch-none mr-1 flex-shrink-0" onclick="event.stopPropagation()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                </div>
                                
                                <div class="bg-yellow-100 p-3 rounded-xl mr-4 flex-shrink-0 group-hover:bg-yellow-200 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                                </div>
                                
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-lg font-bold text-gray-900 break-words whitespace-normal leading-snug mb-1">${build.name}</h3>
                                    <p class="text-sm text-gray-500 font-medium">${date}</p>
                                </div>

                                <div class="selection-checkbox-wrapper flex-shrink-0">
                                    <input type="checkbox" class="custom-checkbox pointer-events-none">
                                </div>
                            </div>`;
                        state.tempBuilds[build.id] = build;
                        listEl.appendChild(el);
                    });

                    if(state.isSelectionMode) listEl.classList.add('selection-mode-active');

                    state.sortableBuilds = new Sortable(listEl, {
                        animation: 150,
                        ghostClass: 'build-ghost', 
                        handle: '.drag-handle',    
                        forceFallback: true, 
                        delay: 100,          
                        touchStartThreshold: 5, 
                        fallbackClass: 'sortable-fallback-styling',
                        onEnd: (evt) => {
                            updateBuildsOrder(); 
                        }
                    });
                }
            });
        }
        window.selectBuild = (id) => navigateTo('tasks', state.tempBuilds[id]);

        function loadTasks(buildId) {
             if (!state.user) return;
             if (state.sortableTasks) state.sortableTasks.destroy();

             const q = query(collection(db, `${BASE_PATH}/tasks`), where('buildId', '==', buildId), where('workspaceId', '==', state.workspaceId));
             state.unsubTasks = onSnapshot(q, (snapshot) => {

                if (state.sortableTasks) {
                    state.sortableTasks.destroy();
                    state.sortableTasks = null;
                }

                 const listEl = document.getElementById('tasks-list'); listEl.innerHTML = '';
                 state.tempTasks = {};

                 if (snapshot.empty) { document.getElementById('no-tasks-msg').classList.remove('hidden'); } 
                 else {
                     document.getElementById('no-tasks-msg').classList.add('hidden');
                     let tasks = []; snapshot.forEach(doc => tasks.push({id: doc.id, ...doc.data()}));
                     
                     tasks.sort((a,b) => (a.order ?? (a.createdAt?.seconds || 0)) - (b.order ?? (b.createdAt?.seconds || 0)));
                     
                     tasks.forEach(task => {
                         const date = task.createdAt ? new Date(task.createdAt.seconds * 1000).toLocaleDateString() : '';
                         const el = document.createElement('div');
                         el.className = 'bg-white p-4 rounded-2xl border border-gray-200 hover:border-blue-500 flex items-center active:bg-blue-50 transition-all group cursor-pointer';
                         el.setAttribute('data-id', task.id);
                         el.onclick = () => window.handleItemClick(task.id, 'task');
                         
                         el.innerHTML = `
                            <div class="drag-handle text-gray-400 p-2 cursor-grab active:cursor-grabbing touch-none flex-shrink-0 mr-1" onclick="event.stopPropagation()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                            </div>
                            
                            <div class="bg-blue-100 p-3 rounded-xl mr-4 flex-shrink-0 group-hover:bg-blue-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                            </div>
                            
                            <div class="flex-1 min-w-0 py-1">
                                <h4 class="text-lg font-bold text-gray-900 break-words whitespace-normal leading-snug mb-1">${task.name}</h4>
                                <p class="text-sm font-medium text-gray-500">${date}</p>
                            </div>

                            <div class="selection-checkbox-wrapper flex-shrink-0">
                                <input type="checkbox" class="custom-checkbox pointer-events-none">
                            </div>`;
                            
                         state.tempTasks[task.id] = task;
                         listEl.appendChild(el);
                     });
                     
                     if(state.isSelectionMode) listEl.classList.add('selection-mode-active');

                     state.sortableTasks = new Sortable(listEl, {
                        animation: 150,
                        ghostClass: 'task-ghost',
                        handle: '.drag-handle',
                        forceFallback: true, 
                        delay: 100,          
                        touchStartThreshold: 5,
                        fallbackClass: 'sortable-fallback-styling',
                        onEnd: (evt) => {
                            updateTasksOrder();
                        }
                    });
                 }
             });
        }
        window.selectTask = (id) => navigateTo('images', state.tempTasks[id]);

        function loadImages(taskId) {
            if (!state.user) return;
            const q = query(collection(db, `${BASE_PATH}/images`), where('taskId', '==', taskId), where('workspaceId', '==', state.workspaceId));
            state.unsubImages = onSnapshot(q, (snapshot) => {
                const gridEl = document.getElementById('images-grid'); gridEl.innerHTML = '';
                state.imageCountInTask = snapshot.size;
                if (snapshot.empty) { document.getElementById('no-images-msg').classList.remove('hidden'); } 
                else {
                    document.getElementById('no-images-msg').classList.add('hidden');
                    let images = []; snapshot.forEach(doc => images.push({id: doc.id, ...doc.data()}));
                    images.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    images.forEach(imgData => {
                         const el = document.createElement('div');
                         el.className = 'relative aspect-square bg-gray-200 rounded-2xl overflow-hidden cursor-pointer shadow-sm hover:shadow-lg transition-all active:scale-95';
                         el.innerHTML = `
                            <img src="${imgData.base64}" class="w-full h-full object-cover" loading="lazy" alt="${imgData.displayName || 'Site photo'}">
                            ${imgData.displayName ? `<div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 truncate">${imgData.displayName}</div>` : ''}
                         `;
                         el.onclick = () => openImagePreview(imgData); gridEl.appendChild(el);
                    });
                }
            });
        }

        window.handleImageUpload = async (event) => {
            const file = event.target.files[0]; if (!file || !state.currentTask) return;
            document.getElementById('upload-progress').classList.remove('hidden');
            try {
                const compressedBase64 = await compressImage(file, 1024, 0.7);

                const nextNum = state.imageCountInTask + 1;
                const safeTaskName = state.currentTask.name.replace(/[^a-z0-9]/gi, '-');
                const displayName = `${safeTaskName}_${nextNum}.jpg`;

                await addDoc(collection(db, `${BASE_PATH}/images`), { 
                    workspaceId: state.workspaceId, 
                    taskId: state.currentTask.id, 
                    base64: compressedBase64, 
                    displayName: displayName,
                    createdAt: serverTimestamp(), 
                    createdBy: state.user.uid 
                });
            } catch (error) { console.error(error); alert("Upload failed."); } 
            finally { document.getElementById('upload-progress').classList.add('hidden'); event.target.value = ''; }
        };

        window.deleteCurrentImage = async () => {
            if (!state.currentImageId || !confirm("Are you sure you want to delete this photo?")) return;
            closeModal('image-preview-modal');
            try {
                await deleteDoc(doc(db, `${BASE_PATH}/images`, state.currentImageId));
            } catch (e) {
                console.error("Delete failed", e);
                alert("Failed to delete image.");
            }
        }
        
        window.downloadCurrentImage = () => {
            if (!state.currentImageData) return;
            saveAs(state.currentImageData.base64, state.currentImageData.displayName || 'site_photo.jpg');
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (ev) => { const img = new Image(); img.src = ev.target.result;
                    img.onload = () => {
                        let w = img.width, h = img.height; if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality));
                    }; img.onerror = reject;
                }; reader.onerror = reject;
            });
        }

        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); if(id.includes('new')) setTimeout(() => document.getElementById(id.replace('-modal', '-name')).focus(), 100); }
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openImagePreview = (imgData) => {
            state.currentImageId = imgData.id;
            state.currentImageData = imgData; // save for download
            document.getElementById('preview-image-el').src = imgData.base64;
            document.getElementById('preview-name').textContent = imgData.displayName || '';
            document.getElementById('preview-meta').textContent = `Captured: ${imgData.createdAt ? new Date(imgData.createdAt.seconds * 1000).toLocaleString() : 'Just now'}`;
            document.getElementById('image-preview-modal').classList.remove('hidden');
        }
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>